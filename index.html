<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>長島スパーランド アトラクションラリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Noto Sans JP', sans-serif; }
      .font-pop { font-family: 'Mochiy Pop One', sans-serif; }
      .custom-checkbox:checked {
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        border-color: #3b82f6;
        background-color: #3b82f6;
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .status-item { display: flex; align-items: center; }
      .status-icon { width: 24px; height: 24px; margin-right: 8px; }
    </style>
  </head>
  <body class="bg-gradient-to-b from-blue-200 to-green-200 min-h-screen">

    <div id="group-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 font-pop">参加するグループを選んでね！</h2>
        <div id="group-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <!-- Group buttons will be inserted here by JS -->
        </div>
        <div id="status-panel" class="mt-6 p-4 bg-gray-100 rounded-lg text-left text-sm">
            <h3 class="font-bold text-gray-700 mb-2">接続ステータス（診断モード）</h3>
            <div id="status-list" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 max-w-md hidden">
      <header class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-6 sticky top-4 z-10">
        <h1 class="text-xl md:text-2xl font-bold text-center text-gray-800 font-pop">長島スパーランド<br>アトラクションラリー</h1>
        <div class="mt-4 text-center">
          <p id="group-name-display" class="text-lg text-blue-600 font-bold">（グループ名）</p>
          <p class="text-4xl md:text-6xl font-bold text-blue-600 font-pop transition-all duration-300" id="total-points">0</p>
        </div>
      </header>
      <section class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-center text-gray-800 mb-4 font-pop">リアルタイムランキング</h2>
        <div id="scoreboard" class="space-y-3"></div>
      </section>
      <main id="attraction-list" class="space-y-4"></main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // ▼▼▼▼▼ Firebaseのセットアップ情報 ▼▼▼▼▼
      // 【最重要】この下の const firebaseConfig = { ... }; の部分全体を、
      // あなた自身のFirebaseプロジェクトからコピーしたコードで完全に置き換えてください。
      const firebaseConfig = {
        apiKey: "AIzaSyC5qCuL_OUzH_TyEtg-aW9AkI-I_mBUPKo",
        authDomain: "nagasap-f23c5.firebaseapp.com",
        projectId: "nagasap-f23c5",
        storageBucket: "nagasap-f23c5.firebasestorage.app",
        messagingSenderId: "582187448865",
        appId: "1:582187448865:web:4835e9e99428f50f38c160"
      };
      // ▲▲▲▲▲ Firebaseのセットアップ情報 ▲▲▲▲▲


      // --- グローバル変数 ---
      let currentGroupId = null;
      const groupNames = ["A", "B", "C", "D", "E"];
      const attractions = [
        { name: 'スチールドラゴン2000', points: 250, category: 'SSSランク', color: 'red', memo: 'まさにキング・オブ・コースター！待ち時間も最長クラス。これを制覇できれば勝利は目前！' },
        { name: '白鯨（HAKUGEI）', points: 230, category: 'SSSランク', color: 'red', memo: '熱狂的ファンが多いハイブリッドコースター。激しい揺れとスピードで高ポイントをゲット！' },
        { name: 'アクロバット', points: 180, category: 'SSランク', color: 'red', memo: 'うつ伏せで駆け抜ける爽快感が人気！待ち時間も長めなので、計画的に狙いたい。' },
        { name: '嵐（ARASHI）', points: 170, category: 'SSランク', color: 'red', memo: '予測不能な回転が魅力！コアなファンが多く、見た目以上に手強いアトラクション。' },
        { name: 'ジャイアントフリスビー', points: 120, category: 'Sランク', color: 'red', memo: '日本最大級の振り子型絶叫マシン。回転と高さでポイントも高め！' },
        { name: 'スペースショット', points: 100, category: 'Sランク', color: 'red', memo: '一瞬で地上75mへ！拘束時間が短く、回転率が良いので、時間がない時にオススメ。' },
        { name: 'シャトルループ', points: 90, category: 'Sランク', color: 'red', memo: '発進からわずか2秒でトップスピードに！往復タイプの元祖絶叫マシン。' },
        { name: 'コークスクリュー', points: 80, category: 'Sランク', color: 'red', memo: '連続2回転が特徴。スリルと乗りやすさのバランスが良い。' },
        { name: 'ルーピングスター', points: 70, category: 'Aランク', color: 'yellow', memo: '美しい形のループコースター。絶叫系の中では比較的待ち時間が短い傾向。' },
        { name: 'フライングカーペット', points: 60, category: 'Aランク', color: 'yellow', memo: '魔法の絨毯で空中散歩。浮遊感が気持ちいい。' },
        { name: 'バイキング', points: 50, category: 'Aランク', color: 'yellow', memo: '大きな海賊船が左右にスイング！船の端っこが一番スリルがある。' },
        { name: 'ダブルワイルドマウス', points: 40, category: 'Aランク', color: 'yellow', memo: '急カーブと急加速が楽しい！見た目よりスリルがあるかも。' },
        { name: 'ウェーブスウィンガー', points: 30, category: 'Bランク', color: 'blue', memo: '空飛ぶブランコ。回転しながら景色を楽しめる。' },
        { name: 'テレコンバット', points: 25, category: 'Bランク', color: 'blue', memo: '自分で操縦して上下に動かせる戦闘機。' },
        { name: '大観覧車オーロラ', points: 20, category: 'Cランク', color: 'green', memo: '長島スパーランドのシンボル。景色を楽しみながら一休み。' },
        { name: 'メリーゴーランド', points: 15, category: 'Cランク', color: 'green', memo: '馬や馬車に乗って夢の世界へ。定番の癒し系アトラクション。' },
        { name: 'ティーカップ', points: 15, category: 'Cランク', color: 'green', memo: '回しすぎ注意！ファミリーやカップルに人気。' },
        { name: 'ピーターラビットコースター', points: 10, category: 'Dランク', color: 'purple', memo: 'キッズ向けの可愛いジェットコースター。初めてのコースターにぴったり。' },
        { name: 'ちびっこひろば', points: 5, category: 'Dランク', color: 'purple', memo: '小さな子供たちが安心して遊べるエリア。乗り物もたくさん。' }
      ];

      // --- 診断モード用ヘルパー ---
      const statusList = document.getElementById('status-list');
      const addStatus = (message, type = 'pending') => {
        const item = document.createElement('div');
        item.className = 'status-item';
        let icon = '';
        let colorClass = 'text-gray-600';
        if (type === 'success') {
          icon = '✅';
          colorClass = 'text-green-600';
        } else if (type === 'error') {
          icon = '❌';
          colorClass = 'text-red-600 font-bold';
        } else {
          icon = '⏳';
        }
        item.innerHTML = `<span class="status-icon">${icon}</span> <span class="${colorClass}">${message}</span>`;
        statusList.appendChild(item);
      };

      // --- メイン処理 ---
      async function main() {
        try {
          addStatus('Firebase設定の読み込み');
          if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
            throw new Error('設定情報が更新されていません。');
          }
          addStatus('Firebase設定の読み込み: ✅ 成功', 'success');

          addStatus('Firebaseの初期化');
          const app = firebase.initializeApp(firebaseConfig);
          addStatus('Firebaseの初期化: ✅ 成功', 'success');

          const auth = firebase.auth();
          const db = firebase.firestore();

          addStatus('匿名認証でサインイン');
          await auth.signInAnonymously();
          addStatus('匿名認証でサインイン: ✅ 成功', 'success');

          addStatus('データベース接続のテスト');
          await db.collection('_test').doc('_test').get();
          addStatus('データベース接続のテスト: ✅ 成功', 'success');

          addStatus('アプリの準備完了！グループを選択してください。', 'success');

          setupGroupSelection(db);
          setupAttractionList(db);

        } catch (e) {
          console.error("致命的なエラー:", e);
          addStatus(`エラー: ${e.message}`, 'error');
          if (e.message && e.message.includes("auth/configuration-not-found")) {
              addStatus("ヒント: Firebase設定情報が正しくありません。Firebaseコンソールからもう一度コピーしてください。", "error");
          } else if (e.message && e.message.includes("Could not reach Firestore backend")) {
              addStatus("ヒント: ネットワーク接続またはFirebaseのセキュリティルールを確認してください。", "error");
          }
        }
      }

      function setupGroupSelection(db) {
        const selectionDiv = document.getElementById('group-selection');
        selectionDiv.innerHTML = '';
        groupNames.forEach((name, index) => {
          const button = document.createElement('button');
          button.className = "p-4 bg-blue-500 text-white font-bold rounded-lg text-xl hover:bg-blue-600 transition";
          button.textContent = `Group ${name}`;
          button.onclick = () => selectGroup(db, `group-${index + 1}`, `Group ${name}`);
          selectionDiv.appendChild(button);
        });
      }

      function selectGroup(db, groupId, groupName) {
        currentGroupId = groupId;
        const groupDocRef = db.collection("groups").doc(groupId);
        
        groupDocRef.get().then(doc => {
          if (!doc.exists) {
            groupDocRef.set({
              name: groupName,
              score: 0,
              checkedAttractions: []
            }).then(() => showAppUIAndStartListening(db, groupName))
              .catch(e => console.error("グループ作成エラー", e));
          } else {
            showAppUIAndStartListening(db, groupName);
          }
        }).catch(e => console.error("グループ取得エラー", e));
      }

      function showAppUIAndStartListening(db, groupName) {
        document.getElementById('group-name-display').textContent = `${groupName} のポイント`;
        document.getElementById('group-modal').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        listenToScores(db);
      }

      function listenToScores(db) {
        db.collection("groups").onSnapshot(snapshot => {
          let groups = [];
          snapshot.forEach(doc => {
            if (doc.exists) groups.push({ id: doc.id, ...doc.data() });
          });
          updateScoreboardUI(groups);
          const myGroup = groups.find(g => g.id === currentGroupId);
          if (myGroup) {
            document.getElementById('total-points').textContent = myGroup.score || 0;
            const checkedIds = myGroup.checkedAttractions || [];
            attractions.forEach((_, index) => {
              const checkbox = document.getElementById(`checkbox-${index}`);
              if (checkbox) checkbox.checked = checkedIds.includes(checkbox.id);
            });
          }
        }, e => console.error("データ監視エラー", e));
      }
      
      function updateScoreboardUI(groups) {
        const scoreboardDiv = document.getElementById('scoreboard');
        scoreboardDiv.innerHTML = '';
        groups.sort((a, b) => (b.score || 0) - (a.score || 0));
        groups.forEach((group, index) => {
            const isMyGroup = group.id === currentGroupId;
            const rank = index + 1;
            let medal = (rank === 1) ? '🥇' : (rank === 2) ? '🥈' : (rank === 3) ? '🥉' : '';
            scoreboardDiv.innerHTML += `
            <div class="flex items-center p-3 rounded-lg ${isMyGroup ? 'bg-blue-100 ring-2 ring-blue-400' : 'bg-gray-50'}">
              <div class="text-xl font-bold w-10">${medal || rank}</div>
              <div class="flex-grow font-semibold text-gray-700">${group.name}</div>
              <div class="text-xl font-bold text-blue-500">${group.score || 0} pt</div>
            </div>`;
        });
      }

      function setupAttractionList(db) {
        const listElement = document.getElementById('attraction-list');
        listElement.innerHTML = '';
        attractions.forEach((attr, index) => {
          listElement.innerHTML += `
            <div id="card-${index}" class="bg-white p-4 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
              <div class="flex items-start">
                <div class="flex-grow">
                  <span class="inline-block bg-${attr.color}-200 text-${attr.color}-800 text-xs px-2 py-1 rounded-full font-semibold">${attr.category}</span>
                  <h2 class="text-lg font-bold mt-1 text-gray-800">${attr.name}</h2>
                  <p class="text-sm text-gray-500 mt-1">${attr.points} ポイント</p>
                  <p class="text-xs text-gray-600 mt-2 border-l-2 border-gray-200 pl-2">${attr.memo}</p>
                </div>
                <div class="flex-shrink-0 ml-4 pt-5">
                   <input type="checkbox" id="checkbox-${index}" data-points="${attr.points}" onchange="updateTotalPoints(this, db)"
                     class="custom-checkbox appearance-none w-8 h-8 rounded-lg border-2 border-gray-300 bg-white checked:bg-blue-500 checked:border-blue-500 focus:outline-none transition duration-200 cursor-pointer">
                </div>
              </div>
            </div>`;
        });
      }

      function updateTotalPoints(checkbox, db) {
          const points = parseInt(checkbox.dataset.points, 10);
          const checkboxId = checkbox.id;
          if (currentGroupId) {
              const groupDocRef = db.collection("groups").doc(currentGroupId);
              const updateData = {
                  score: firebase.firestore.FieldValue.increment(checkbox.checked ? points : -points),
                  checkedAttractions: checkbox.checked 
                      ? firebase.firestore.FieldValue.arrayUnion(checkboxId) 
                      : firebase.firestore.FieldValue.arrayRemove(checkboxId)
              };
              groupDocRef.update(updateData).catch(e => {
                  console.error("ポイント更新エラー", e);
                  checkbox.checked = !checkbox.checked;
              });
          }
      }
      
      document.addEventListener('DOMContentLoaded', main);
    </script>
  </body>
</html>

